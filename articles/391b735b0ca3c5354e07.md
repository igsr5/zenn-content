---
title: "N+1å•é¡Œã«ã¤ã„ã¦"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['rails','ruby','sql','N+1','backend']
published: true
---
èª¤ã‚ŠãŒã‚ã£ãŸã‚‰æŒ‡æ‘˜ã—ã¦ã„ãŸã ããŸã„ã§ã™ã€‚
# N*+1ã‚¯ã‚¨ãƒªã¨ã¯
- SQLç™ºè¡Œã®ç„¡é§„ã®ã“ã¨ã€‚
## ä¾‹
```ruby:user.rb
class User < ApplicationRecord
  has_one :address
end
```
```ruby:address.rb
class Address < ApplicationRecord
  belongs_to :user
end
```
ä¸Šã®ã‚ˆã†ãª2ã¤ã®ãƒ¢ãƒ‡ãƒ«ãŒã‚ã£ãŸã¨ã™ã‚‹ã€‚
```ruby
- User.all.each do |user|
  = user.address.city
```
ãã®æ™‚ã€ã“ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¨N+1å•é¡ŒãŒèµ·ã“ã‚‹ã€‚
æœ€åˆã«userã‚’å–å¾—ã™ã‚‹å‡¦ç†ãŒã‚ã£ãŸå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ•°ã ã‘addressã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã“ã¨ã§ç„¡é§„ãŒç”Ÿã¾ã‚Œã¦ã„ã‚‹ã®ã§ã‚ã‚‹ã€‚
### è§£æ±ºæ–¹æ³•
```
- User.includes(:address).all.each do |user|
  = user.address.city
```
ã“ã‚“ãªæ„Ÿã˜ã®ã‚³ãƒ¼ãƒ‰ã«ä¿®æ­£ã™ã‚‹ã€‚
ã“ã†ã™ã‚‹ã¨ã€é–¢é€£ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰æœ€åˆã«ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ãã¦ãã‚Œã‚‹ãŸã‚ã€ã„ã¡ã„ã¡addressã®ãƒ‡ãƒ¼ã‚¿ãŒç™ºè¡Œã•ã‚Œãªã„ã€‚
`preload`,`eager_load`ã§ã‚‚åŒæ§˜ã«è§£æ±ºã§ãã‚‹ã€‚
ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®é•ã„ã¯é–¢é€£ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã©ã®ã‚ˆã†ãªã‚¯ã‚¨ãƒªã§å–å¾—ã™ã‚‹ã‹ã€‚
`preload`ã¯è¤‡æ•°å›ã€`eager_load`ã¯1å›ã€`includes`ã¯ãã‚Œã‚‰ã‚’ã„ã„æ„Ÿã˜ã«ä½¿ã„åˆ†ã‘ã¦ãã‚Œã‚‹ï¼Ÿï¼ˆä¸å®‰ï¼‰ã‚‰ã—ã„ã€‚
